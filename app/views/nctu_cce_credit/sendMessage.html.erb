<%= render partial: "layouts/managementHeader", locals: {item: @item} %>
<%= render partial: "user", locals: {item: @item} %>
<br><br>
<div class="container" >
<%= form_tag('/nctu_cce_credit/sendMessage', multipart: true, class: "form-horizontal") do%>
  <%=hidden_field_tag 'id', @item.id%>
  <div class="form-group">
    <label class="col-sm-offset-1 col-sm-2 control-label">標題</label>
    <div class="col-sm-6">
      <%= text_field_tag 'subject', nil, class: 'form-control', placeholder: '標題'%>	
    </div>
  </div>
  <div class="form-group">  
    <label for="inputEmail3" class="col-sm-offset-1 col-sm-2 control-label">收件人</label>  	
    <div class="col-sm-6"  style="height: 200px; overflow-y: scroll;"> 
    	<%@item.sub_items.each do |s_i| %>
			<%=s_i.title%><br>   
			<label class="checkbox-inline">
				<%= check_box_tag 'sub_item_'+s_i.id%>全選			
			</label>   			 	
    		<%s_i.registered_sub_items.each do |rsi| %>
    			<%if rsi.progress.stage>= 4%>
					<label class="checkbox-inline">
						<%= check_box_tag 'recipients[]', rsi.progress.user.id, false, class: 'rsi_of_sub_item_'+s_i.id%><%=rsi.progress.user.name %>
					</label>    			
    			<%end%>	
    		<%end%>
    	<hr>
    	<%end%>
    </div>	
  </div>  
  <div class="form-group">
    <label class="col-sm-offset-1 col-sm-2 control-label">內容</label>
    <div class="col-sm-6">
    	<%= text_area_tag 'content', nil, class: 'form-control', rows: 3, cols: 10, placeholder: "內容"%>
    </div>
  </div>
  <div class="form-group">
    <label class="col-sm-offset-1 col-sm-2 control-label">附件</label>
	<div class="col-sm-6">
 		<input name="attachment[]" id="input-att" type="file" class="file" data-preview-file-type="text" multiple>
	</div>   
  </div> 
  <div class="form-group">
    <div class="col-sm-offset-3 col-sm-6">
      <%=submit_tag "寄出", class: "btn btn-primary submitButton", "data-loading-text"=>"寄送中...", autocomplete: "off"%>	
    </div>
  </div>
<%end%>
<script>
$("#input-att").fileinput({'showUpload':false, browseClass: "btn btn-default", browseLabel: " 選取檔案（可多選）", 'previewFileType':'any', 'showCaption': false});

$('form').submit(function(event){
	var recipients_error = true
	$('input[name^="recipients"]').each(function() {
	    if( this.checked )
	    	recipients_error = false
	});
	if($('#subject').val() == '')
	{
		addAlert('error', '您沒填標題')		
		$(".submitButton").button('reset')					
		event.preventDefault();
		return false		
	}	
	if(recipients_error)
	{
		addAlert('error', '您沒選擇收件人')	
		$(".submitButton").button('reset')			
		event.preventDefault();
		return false
	}
	$(".submitButton").button('loading')
})


<%@item.sub_items.each do |s_i| %>
$('#sub_item_<%=s_i.id %>').change(function() {
   if ( this.checked )
   	$('.rsi_of_sub_item_<%=s_i.id%>').prop('checked', true);
   else
   	$('.rsi_of_sub_item_<%=s_i.id%>').prop('checked', false);
});
<%end%>

</script>